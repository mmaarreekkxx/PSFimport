<!DOCTYPE html>
<html lang="pl" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import PSF - Analiza Danych</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Konfiguracja Tailwind
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {}
      }
    }
  </script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* Usunięto wszystkie marginesy z main-container i inner-container */
    .main-container {
      padding: 0;
      margin: 0;
    }

    .inner-container {
      padding: 0;
      margin: 0;
    }

    .dragover{border-color:#3B82F6!important;background-color:#EBF8FF!important}.animate-fade-in{animation:fadeIn .3s ease-in}@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}.badge{display:inline-block;padding:2px 6px;font-size:10px;font-weight:500;border-radius:12px}.product-code{font-family:'Courier New',monospace;font-weight:700;font-size:11px;padding:1px 4px;background-color:rgba(0,0,0,.1);border-radius:3px}.no-results{text-align:center;padding:20px;color:#6B7280;font-style:italic}.group-scroll::-webkit-scrollbar{width:6px}.group-scroll::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}.group-scroll::-webkit-scrollbar-thumb{background:#888;border-radius:10px}.group-scroll::-webkit-scrollbar-thumb:hover{background:#555}.toggle-container{position:relative;display:inline-block;width:140px;height:32px;background-color:#e5e7eb;border-radius:16px;cursor:pointer;transition:background-color .3s ease}.toggle-container.checked{background-color:#3b82f6}.toggle-slider-button{position:absolute;top:2px;left:2px;width:calc(50% - 2px);height:28px;background-color:#fff;border-radius:14px;box-shadow:0 2px 4px rgba(0,0,0,.2);transition:transform .3s ease;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:500;color:#374151}.toggle-container.checked .toggle-slider-button{transform:translateX(70px)}.toggle-label-left,.toggle-label-right{position:absolute;top:0;height:32px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:500}.toggle-label-left{left:10px;color:#374151}.toggle-label-right{right:10px;color:#fff}@media (max-width:640px){.badge{font-size:9px;padding:1px 4px}.product-code{font-size:10px}}

    /* Style dla aktywnych przycisków grupowania */
    .grouping-button.active {
      background-color: #059669 !important;
      box-shadow: 0 0 0 2px rgba(5, 150, 105, 0.5);
    }
    .grouping-button.active:hover {
      background-color: #047857 !important;
    }
    
    /* Dodatkowe style dla trybu ciemnego */
    .dark .toggle-container { background-color: #4B5563; }
    .dark .toggle-container.checked { background-color: #3B82F6; }
    .dark .toggle-slider-button { background-color: #fff; color: #1F2937; }
    .dark .toggle-label-left { color: #E5E7EB; }
    .dark .toggle-label-right { color: #fff; }
    .dark .product-code { background-color: rgba(255,255,255,0.1); }
    
    /* Poprawki dla DataTables w trybie ciemnym */
    .dark .dataTables_wrapper .dataTables_length,
    .dark .dataTables_wrapper .dataTables_filter,
    .dark .dataTables_wrapper .dataTables_info,
    .dark .dataTables_wrapper .dataTables_processing,
    .dark .dataTables_wrapper .dataTables_paginate {
      color: #E5E7EB !important;
    }
    
    .dark .dataTables_wrapper .dataTables_paginate .paginate_button.disabled,
    .dark .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover,
    .dark .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:active {
      color: #9CA3AF !important;
    }
    
    .dark .dataTables_wrapper .dataTables_paginate .paginate_button {
      color: #E5E7EB !important;
    }
    
    .dark .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dark .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
      background: #374151 !important;
      color: white !important;
      border-color: #4B5563 !important;
    }
    
    .dark .dataTables_wrapper .dataTables_length select,
    .dark .dataTables_wrapper .dataTables_filter input {
      background-color: #374151 !important;
      color: #E5E7EB !important;
      border: 1px solid #4B5563 !important;
    }

    .data-table {
      font-size: 12px; /* Standardowy rozmiar dla desktop */
    }

    .data-table th {
      font-size: 12px;
      font-weight: 600;
    }

    .data-table td {
      font-size: 12px;
    }

    /* Poprawka dla widoku mobilnego */
    @media (max-width: 768px) {
      .data-table {
        font-size: 10px;
      }
      
      .data-table th,
      .data-table td {
        font-size: 10px;
        padding: 6px 4px;
      }
    }
  
    /* Zastosuj te same style co w pozostałych tabelach */
    .data-table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #e0e0e0;
      padding: 8px;
      text-align: left;
    }

    .data-table th {
      background-color: #f5f5f5;
    }

    .data-table tr:nth-child(even) {
      background-color: #fafafa;
    }

    .group-details { 
      overflow-y: auto; 
      transition: max-height .3s ease-out; 
    }
    .group-details.expanded { 
      max-height: 2000px; 
      transition: max-height .5s ease-in; 
    }
    
    /* Animacje dla interfejsu */
    .card { @apply bg-gray-100 dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 transition-all duration-200; }
    .card:hover { @apply shadow-md; }
    .group-896 { background-color:#E6F3FF; } .group-896:hover { background-color:#CCE7FF; }
    .group-898 { background-color:#B3FFB3; } .group-898:hover { background-color:#80FF80; }
    .group-905 { background-color:#E6FFE6; } .group-905:hover { background-color:#CCFFCC; }
    .group-909 { background-color:#FFF3E6; } .group-909:hover { background-color:#FFC680; }
    .group-903 { background-color:#FFF3E6; } .group-903:hover { background-color:#FFE7CC; }
    #dataTable { transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; }

    /* Animacje dla ładowania */
    .spin-loader {
      border-radius: 50%;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top-color: #3b82f6;
      animation: spinner 1s linear infinite;
    }
    @keyframes spinner {
      to {transform: rotate(360deg);}
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 antialiased min-h-full">
  <div class="w-full py-3 max-w-full">
    <div id="alertContainer" class="fixed top-4 right-4 z-50 w-80 max-w-sm hidden"></div>
    
    <!-- Header Section - Kompaktowy -->
    <div class="mb-3 px-2">
      <div class="flex flex-row justify-between items-center">
        <div class="flex items-center gap-3">
          <h1 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-file-import mr-2 text-blue-600"></i>Import PSF
          </h1>
          <span id="fileCountBadge" class="hidden bg-blue-500 text-white text-xs px-2 py-1 rounded-full"></span>
        </div>
        
        <div class="flex items-center gap-2">
          <div class="flex items-center gap-2">
            <i class="fas fa-moon text-sm text-gray-500 dark:text-gray-400"></i>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="darkModeToggle" class="sr-only">
              <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
            </label>
          </div>
          
          <button id="clearDataButton" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors text-sm">
            <i class="fas fa-trash mr-1"></i>Wyczyść
          </button>
          <button id="printButton" class="px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm">
            <i class="fas fa-print mr-1"></i>Drukuj
          </button>
        </div>
      </div>
    </div>

    <!-- Import plików - Kompaktowy -->
    <div class="mb-4 px-2">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3">
        <h2 class="text-base font-semibold mb-3 text-gray-900 dark:text-white">
          <i class="fas fa-upload mr-2"></i>Import plików
        </h2>
        
        <div id="dropzone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center hover:border-blue-500 transition-colors cursor-pointer">
          <div class="space-y-1">
            <i class="fas fa-cloud-upload-alt text-2xl text-gray-400"></i>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              Przeciągnij i upuść pliki tutaj lub <span class="text-blue-600 font-medium">kliknij aby wybrać</span>
            </p>
            <p class="text-xs text-gray-500">Obsługiwane formaty: CSV, XLSX, XLS</p>
          </div>
          <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls" class="hidden">
        </div>
        
        <div id="loadingSpinner" class="hidden flex items-center justify-center mt-3">
          <div class="spin-loader mr-2"></div>
          <span class="text-sm text-gray-600 dark:text-gray-400">Przetwarzanie plików...</span>
        </div>
      </div>
    </div>

    <!-- Analiza wizualna obok Podsumowania -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mb-4 sm:mb-6 px-2">
      <!-- Analiza wizualna - 2/3 szerokości -->
      <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 sm:p-4">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
              <i class="fas fa-chart-pie mr-2"></i>Analiza wizualna
            </h2>
            <select id="chartTypeSelect" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-white">
              <option value="donut">Wykres pierścieniowy</option>
              <option value="pie">Wykres kołowy</option>
              <option value="bar">Wykres słupkowy</option>
              <option value="line">Wykres liniowy</option>
              <option value="area">Wykres obszarowy</option>
              <option value="radialBar">Wykres promieniowy</option>
              <option value="heatmap">Mapa cieplna</option>
              <option value="treemap">Mapa drzewa</option>
            </select>
          </div>
          <div id="pieChart"></div>
        </div>
      </div>

      <!-- Podsumowanie - 1/3 szerokości -->
      <div class="lg:col-span-1">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 sm:p-4">
          <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
            <i class="fas fa-calculator mr-2"></i>Podsumowanie
          </h2>
          <div class="space-y-3">
            <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
              <span class="text-sm font-medium">Netto:</span>
              <span id="totalNetto" class="font-bold text-blue-600 dark:text-blue-400">0,00 zł</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
              <span class="text-sm font-medium">VAT:</span>
              <span id="totalVAT" class="font-bold text-green-600 dark:text-green-400">0,00 zł</span>
            </div>
            <div class="flex justify-between items-center p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
              <span class="text-sm font-medium">Brutto:</span>
              <span id="totalBrutto" class="font-bold text-purple-600 dark:text-purple-400">0,00 zł</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grupowanie -->
    <div class="mb-4 px-2">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 sm:p-4">
        <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-4">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
            <i class="fas fa-layer-group mr-2"></i>Grupowanie
          </h2>
        </div>
        
        <div class="mb-4">
          <input type="text" id="groupSearch" placeholder="Szukaj w grupach..." 
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm">
        </div>

        <div class="flex flex-wrap gap-2 mb-4 items-center">
          <button id="expandAllGroups" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs">
            <i class="fas fa-expand-alt mr-1"></i>Rozwiń wszystkie
          </button>
          <button id="collapseAllGroups" class="px-2 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-xs">
            <i class="fas fa-compress-alt mr-1"></i>Zwiń wszystkie
          </button>
          
          <!-- Przełącznik grupowania w stylu przycisków -->
          <button id="groupByProduct" class="px-2 py-1 bg-gray-500 hover:bg-green-600 text-white rounded text-xs grouping-button active">
            <i class="fas fa-box mr-1"></i>Produkt
          </button>
          <button id="groupByRegistration" class="px-2 py-1 bg-gray-500 hover:bg-green-600 text-white rounded text-xs grouping-button">
            <i class="fas fa-file-alt mr-1"></i>Rejestracja
          </button>
        </div>

        <div id="productGroupsSummary" class="space-y-2 max-h-110 overflow-y-auto group-scroll"></div>
      </div>
    </div>

    <!-- Tabela danych -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 sm:p-4 mx-2">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          <i class="fas fa-table mr-2"></i>Tabela danych
        </h2>
        <div class="flex flex-wrap items-center gap-2">
          <input type="text" id="tableSearch" placeholder="Szukaj w tabeli..." 
                 class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm w-full sm:w-auto">
          
          <div class="relative">
            <button id="exportButton" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors text-sm">
              <i class="fas fa-download mr-1"></i>Eksport
            </button>
            <div id="exportDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-10">
              <div class="py-1">
                <button id="exportExcel" class="w-full text-left px-4 py-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-900 dark:text-white">
                  <i class="fas fa-file-excel mr-2"></i>Excel (.xlsx)
                </button>
                <button id="exportPDF" class="w-full text-left px-4 py-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-900 dark:text-white">
                  <i class="fas fa-file-pdf mr-2"></i>PDF
                </button>
                <button id="exportCSV" class="w-full text-left px-4 py-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-900 dark:text-white">
                  <i class="fas fa-file-csv mr-2"></i>CSV
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table id="dataTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-800"></thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
      </div>
    </div>
  </div>
<script>
"use strict";
$(document).ready(function() {
  const GROUP_ROW_CHUNK = 250;
  
  // Utility functions
  const debounce = (fn, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn.apply(this, args), delay);
    };
  };
  
  const getTextColorClass = code => {
    const colorClass = CONFIG.produktKodyColors[code] || CONFIG.produktKodyColors[''];
    const match = colorClass.match(/(text-[^\s]+)/);
    return match ? match[1] : "";
  };
  
  const formatDateToYYYYMMDD = date => {
    let d = date instanceof Date ? date : new Date(date);
    if(isNaN(d)) return date;
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };
  
  const formatAmount = amt => new Intl.NumberFormat('pl-PL', { 
    minimumFractionDigits: 2, 
    maximumFractionDigits: 2, 
    style: 'currency', 
    currency: 'PLN' 
  }).format(parseFloat(amt) || 0);
  
  const formatNumber = num => new Intl.NumberFormat('pl-PL', { 
    minimumFractionDigits: 2, 
    maximumFractionDigits: 2 
  }).format(parseFloat(num) || 0);
  
  const mapRegistrationNumber = nrRej => {
    if (!nrRej) return nrRej;
    const trimmed = nrRej.toString().trim();
    return CONFIG.nrRejMapping[trimmed] || trimmed;
  };
  
  // Application state
  let state = {
    data: [],
    importedFiles: [],
    summary: { totalNetto: 0, totalVAT: 0, totalBrutto: 0, productGroups: {} },
    settings: {
      darkMode: false,
      defaultExportFormat: 'xlsx',
      rowsPerPage: 25,
      groupBy: 'IMPORTKODPRODUKTU',
      chartType: 'donut'
    },
    charts: { pie: null },
    dataTable: null
  };
  
  // Configuration
  const CONFIG = {
    columnMapping: {
      'NR. REJ.': ['NR. REJ.', 'ImportNrRejestracyjny', 'Nr rejestracyjny'],
      'IMPORTKODPOZYCJI': ['IMPORTKODPOZYCJI', 'Importkodpozycji'],
      'STAWKAVAT': ['STAWKAVAT', 'Stawka vat'],
      'IMPORTKODPRODUKTU': ['IMPORTKODPRODUKTU', 'Produkt', 'Grupa prod'],
      'NETTO': ['NETTO', 'Wartość netto', 'Wartość netto fak'],
      'VAT': ['VAT', 'Wartość vat fak'],
      'StanLicznika': ['StanLicznika', 'Licznik'],
      'DataTransakcji': ['Data realizacji', 'Data transakcji', 'DataTransakcji'],
      'TRESC': ['TRESC', 'Dane kosztowe', 'Opis']
    },
    nrRejMapping: {
      'CB032NM': 'CMG4651A', 'CB885NL': 'CMG4649A', 'CB976NL': 'CMG4724A',
      'CB027NM': 'CMG4647A', 'CB977NL': 'CMG4728A', 'CB698NL': 'CMG4650A',
      'CB026NM': 'CMG4773A', 'CB884NL': 'CMG4729A', 'CB864NL': 'CMG4743A',
      'CB196NL': 'CMG4652A', 'CB861NL': 'CMG4732A', 'CB623NK': 'CMG4648A',
      'CB449NL': 'CMG4758A', 'CB029NM': 'CMG4754A', 'CB964NK': 'CMG4891A',
      'CB695NL': 'CMG4850A', 'CB447NL': 'CMG4757A', 'CB697NL': 'CMG4731A',
      'CB195NL': 'CMG4755A', 'CB949NL': 'CMG4759A', 'CB185NN': 'CMG4750A',
      'CB807NN': 'CMG4751A', 'CB671NN': 'CMG4748A', 'CB629NN': 'CMG4752A',
      'CB827NN': 'CMG4753A', 'CB826NN': 'CMG4746A', 'CB498NN': 'CMG4727A',
      'CB802NN': 'CMG4726A', 'CB499NN': 'CMG4745A', 'CB805NN': 'CMG4730A',
      'CB801NN': 'CMG4725A', 'CB184NN': 'CMG4756A', 'CB674NN': 'CMG4890A'
    },
    // Oryginalna struktura kolumn
    requiredColumns: ['NR. REJ.', '', '', 'NETTO', 'STAWKAVAT', 'VAT', 'TRESC', 'IMPORTKODPRODUKTU'],
    produktKody: {
      'Części do norm czasowych': '896', 'Części do obsługi technicznej': '896', 'Część': '896',
      'Opona zimowa': '898', 'Opona letnia': '898', 'Przechowanie opon': '905',
      'Usługa oponiarska': '905', 'Obsługa techniczna': '909', 'Normy czasowe': '903',
      'Usługa warsztatowa': '903', 'Usługa inna': '903', 'Felga': '898', 'Usługa kurierska': '903'
    },
    produktKodyColors: {
      '896': 'bg-[#E6F3FF] text-blue-800 border-blue-200',
      '898': 'bg-[#B3FFB3] text-green-800 border-green-200',
      '903': 'bg-[#FFF3E6] text-yellow-800 border-yellow-200',
      '905': 'bg-[#E6FFE6] text-green-800 border-green-200',
      '909': 'bg-[#FFF3E6] text-red-800 border-red-200',
      '': 'bg-gray-100/50 text-gray-800 border-gray-200'
    },
    produktKodyNames: {
      '896': 'Części', '898': 'Opony i felgi', '903': 'Usługi warsztatowe',
      '905': 'Usługi oponiarskie', '909': 'Obsługa techniczna', '': 'Inne'
    },
    produktKodyIcons: {
      '896': '<i class="fas fa-cogs mr-2"></i>',
      '898': '<i class="fas fa-circle-notch mr-2"></i>',
      '903': '<i class="fas fa-tools mr-2"></i>',
      '905': '<i class="fas fa-car mr-2"></i>',
      '909': '<i class="fas fa-wrench mr-2"></i>',
      '': '<i class="fas fa-question-circle mr-2"></i>'
    }
  };
  
  // Data processing
  const processData = jsonData => {
    const mappings = Object.entries(CONFIG.columnMapping);
    return jsonData.map(row => {
      const clean = {};
      
      // Column mapping
      for (const [std, poss] of mappings) {
        for (const col of poss) {
          const match = Object.keys(row).find(k => k.trim().toUpperCase() === col.trim().toUpperCase());
          if (match) { 
            clean[std] = row[match]; 
            break; 
          }
        }
      }
      
      // Registration number mapping
      if (clean['NR. REJ.']) {
        clean['NR. REJ.'] = mapRegistrationNumber(clean['NR. REJ.']);
      }
      
      // Calculations
      const netto = parseFloat(clean.NETTO) || 0;
      const vat = parseFloat(clean.VAT) || 0;
      clean.BRUTTO = (netto + vat).toFixed(2);
      clean.PRODUKTKOD = CONFIG.produktKody[clean.IMPORTKODPRODUKTU || ''] || '';
      
      // Date formatting
      if (clean.DataTransakcji) {
        clean.DataTransakcji = formatDateToYYYYMMDD(clean.DataTransakcji);
      }
      
      return clean;
    });
  };
  
  const calculateSummaries = (data, groupBy = 'IMPORTKODPRODUKTU') => {
    const summary = { totalNetto: 0, totalVAT: 0, totalBrutto: 0, productGroups: {} };
    
    for (const row of data) {
      const netto = parseFloat(row.NETTO) || 0;
      const vat = parseFloat(row.VAT) || 0;
      const brutto = netto + vat;
      
      const key = row[groupBy] || 'Nieznany';
      const prodCode = groupBy === 'IMPORTKODPRODUKTU'
        ? (CONFIG.produktKody[key] || '')
        : (CONFIG.produktKody[row.IMPORTKODPRODUKTU] || '');
      
      summary.totalNetto += netto;
      summary.totalVAT += vat;
      summary.totalBrutto += brutto;
      
      if (!summary.productGroups[key]) {
        summary.productGroups[key] = { 
          netto: 0, vat: 0, brutto: 0, count: 0, details: [], code: prodCode 
        };
      }
      
      const group = summary.productGroups[key];
      group.netto += netto;
      group.vat += vat;
      group.brutto += brutto;
      group.count++;
      group.details.push({
        tresc: row.TRESC || '',
        importNr: row['NR. REJ.'] || '',
        importKodPozycji: row['IMPORTKODPOZYCJI'] || '',
        importKodProduktu: row.IMPORTKODPRODUKTU || '',
        produktKod: prodCode,
        netto, vat, brutto,
        stawkaVAT: row.STAWKAVAT || '',
        DataTransakcji: row.DataTransakcji || '',
        StanLicznika: row.StanLicznika || ''
      });
    }
    
    return summary;
  };
  
  // UI Functions
  const renderGroupRows = (details, start, count) => {
    return details.slice(start, start + count).map(d =>
      `<tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
         <td class="px-3 py-2 text-sm">${d.importNr}</td>
         <td class="px-3 py-2 text-sm">${(d.tresc || '').replace(/[^a-zA-Z0-9\sąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, '')}</td>
         <td class="px-3 py-2 text-sm">${d.stawkaVAT}</td>
         <td class="px-3 py-2 text-sm">${formatNumber(d.netto)}</td>
         <td class="px-3 py-2 text-sm">${formatAmount(d.brutto)}</td>
         <td class="px-3 py-2 text-sm">${d.DataTransakcji || ''}</td>
         <td class="px-3 py-2 text-sm">${d.StanLicznika || ''}</td>
       </tr>`
    ).join('');
  };
  
  const updateSummaryUI = summary => {
    $('#totalNetto').text(formatAmount(summary.totalNetto));
    $('#totalVAT').text(formatAmount(summary.totalVAT));
    $('#totalBrutto').text(formatAmount(summary.totalBrutto));
    updateProductGroupsUI(summary);
    updateCharts(calculateSummaries(state.data, 'IMPORTKODPRODUKTU'));
    updateFileCountBadge();
  };
  
  const updateProductGroupsUI = summary => {
    const container = $('#productGroupsSummary').empty();
    const search = $('#groupSearch').val().toLowerCase();
    const sorted = Object.entries(summary.productGroups).sort((a, b) => b[1].netto - a[1].netto);
    
    let visible = 0;
    const frag = document.createDocumentFragment();
    
    sorted.forEach(([name, grp], i) => {
      if (search && !name.toLowerCase().includes(search) && 
          !grp.details.some(d => d.tresc.toLowerCase().includes(search))) return;
      
      visible++;
      const code = grp.code || '';
      const color = CONFIG.produktKodyColors[code] || CONFIG.produktKodyColors[''];
      const textColor = getTextColorClass(code);
      const icon = CONFIG.produktKodyIcons[code] || CONFIG.produktKodyIcons[''];
      const pretty = name || 'Nieznany';
      const codeDisplay = code ? ` <span class="product-code">${code}</span>` : '';
      const percentage = ((grp.netto / summary.totalNetto) * 100).toFixed(1);
      const tbodyId = `group-${i}-tbody`;
      
      const groupHTML = `
        <div class="group-container mb-2" id="group-${i}">
          <div class="group-header flex justify-between items-center p-3 rounded-lg border ${color} transition duration-200 cursor-pointer" data-group-id="group-${i}">
            <div class="flex-1">
              <div class="flex items-center">
                ${icon}
                <span class="font-medium">${pretty}${codeDisplay}</span>
                <span class="ml-2 badge bg-white/50 text-gray-700 dark:text-blue-300 mr-2">${grp.count} ${grp.count === 1 ? 'pozycja' : 'pozycji'}</span>
              </div>
            </div>
            <div class="text-right flex items-center gap-2">
              <div>
                <div class="text-xs sm:text-sm font-medium">${formatNumber(grp.netto)}</div>
                <div class="text-[10px] sm:text-xs opacity-70">${percentage}% całości</div>
              </div>
              <div class="text-gray-500 dark:text-gray-400 ml-1">
                <i class="fas fa-chevron-down transition-transform duration-300"></i>
              </div>
            </div>
          </div>
          <div class="group-details ${textColor} bg-white/50 dark:bg-gray-800/50 rounded-b-lg border p-3 mb-2 hidden">
            <div class="grid grid-cols-3 md:grid-cols-3 gap-2 mb-2">
              <div class="p-2 bg-white dark:bg-gray-700 rounded shadow-sm">
                <div class="text-xs ${textColor}">Netto</div>
                <div class="font-semibold ${textColor}">${formatAmount(grp.netto)}</div>
              </div>
              <div class="p-2 bg-white dark:bg-gray-700 rounded shadow-sm">
                <div class="text-xs ${textColor}">VAT</div>
                <div class="font-semibold ${textColor}">${formatAmount(grp.vat)}</div>
              </div>
              <div class="p-2 bg-white dark:bg-gray-700 rounded shadow-sm">
                <div class="text-xs ${textColor}">Brutto</div>
                <div class="font-semibold ${textColor}">${formatAmount(grp.brutto)}</div>
              </div>
            </div>
            <div class="overflow-x-auto overflow-y-auto group-scroll max-h-96">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-800">
                <thead class="bg-gray-50 dark:bg-gray-800 sticky top-0 z-10">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Nr. Rej.</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Opis</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">VAT</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Netto</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Brutto</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Data Transakcji</th>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Stan Licznika</th>
                  </tr>
                </thead>
                <tbody id="${tbodyId}" class="divide-y divide-gray-200 dark:divide-gray-800">
                  ${renderGroupRows(grp.details, 0, GROUP_ROW_CHUNK)}
                  ${grp.details.length > GROUP_ROW_CHUNK ? 
                    `<tr class="load-more-row hover:bg-gray-50 dark:hover:bg-gray-600" 
                        data-group-index="${i}" 
                        data-group-name="${name}" 
                        data-loaded="${GROUP_ROW_CHUNK}" 
                        style="cursor:pointer;">
                      <td colspan="7" class="text-center text-xs sm:text-sm text-blue-600">Pokaż więcej</td>
                    </tr>` : ''}
                </tbody>
              </table>
            </div>
          </div>
        </div>`;
      
      frag.appendChild($(groupHTML)[0]);
    });
    
    if (!visible && search) {
      const noResults = document.createElement('div');
      noResults.className = "no-results";
      noResults.innerHTML = `<i class="fas fa-search mr-1"></i> Brak wyników dla wyszukiwania: "${search}"`;
      frag.appendChild(noResults);
    }
    
    container.append(frag);
  };
  
  const updateCharts = chartSummary => {
    // Group by product codes
    const grouped = {};
    for (const [name, grp] of Object.entries(chartSummary.productGroups)) {
      const code = grp.code || '';
      const codeName = CONFIG.produktKodyNames[code] || name;
      
      if (!grouped[codeName]) grouped[codeName] = { netto: 0 };
      grouped[codeName].netto += grp.netto;
    }
    
    // Prepare chart data
    const pieLabels = [];
    const pieData = [];
    const categories = [];
    const seriesData = [];
    const dataPoints = [];
    const colorMap = {};
    
    for (const [name, data] of Object.entries(grouped)) {
      pieLabels.push(name);
      const val = parseFloat(data.netto.toFixed(2));
      pieData.push(val);
      categories.push(name);
      seriesData.push(val);
      dataPoints.push({ x: name, y: val });
    }
    
    // Color mapping
    for (const [name, grp] of Object.entries(chartSummary.productGroups)) {
      const code = grp.code || '';
      const codeName = CONFIG.produktKodyNames[code] || name;
      
      if (!colorMap[codeName]) {
        const colors = {
          '896': '#3B82F6', '898': '#10B981', '903': '#F59E0B',
          '905': '#34D399', '909': '#EF4444'
        };
        colorMap[codeName] = colors[code] || '#6B7280';
      }
    }
    
    const pieColors = pieLabels.map(label => colorMap[label] || '#3B82F6');
    
    // Chart configuration
    const chartType = state.settings.chartType;
    let chartOptions = {};
    
    const baseOptions = {
      chart: {
        height: 320,
        fontFamily: 'Inter, sans-serif',
        toolbar: { show: true },
        background: state.settings.darkMode ? '#1F2937' : '#fff',
        foreColor: state.settings.darkMode ? '#fff' : '#000'
      },
      colors: pieColors,
      tooltip: { 
        theme: state.settings.darkMode ? 'dark' : 'light',
        y: { formatter: value => formatAmount(value) } 
      },
      legend: { 
        position: 'bottom', 
        horizontalAlign: 'center',
        labels: { colors: state.settings.darkMode ? '#fff' : '#000' }
      },
      responsive: [{ 
        breakpoint: 480, 
        options: { 
          chart: { height: 300 }, 
          legend: { position: 'bottom' } 
        } 
      }]
    };
    
    if (chartType === 'donut' || chartType === 'pie') {
      chartOptions = {
        ...baseOptions,
        series: pieData,
        chart: { ...baseOptions.chart, type: chartType },
        labels: pieLabels,
        dataLabels: { 
          enabled: true, 
          formatter: val => val.toFixed(1) + '%',
          style: { colors: [state.settings.darkMode ? '#fff' : '#000'] }
        }
      };
      
      if (chartType === 'donut') {
        chartOptions.plotOptions = {
          pie: {
            donut: {
              size: '55%',
              labels: {
                show: true,
                total: {
                  show: true,
                  showAlways: true,
                  label: 'Suma',
                  color: state.settings.darkMode ? '#fff' : '#000',
                  formatter: w => formatAmount(w.globals.seriesTotals.reduce((a, b) => a + b, 0))
                }
              }
            }
          }
        };
      }
    } else if (['bar', 'line', 'area'].includes(chartType)) {
      chartOptions = {
        ...baseOptions,
        series: [{ data: seriesData }],
        chart: { ...baseOptions.chart, type: chartType },
        xaxis: { 
          categories: categories,
          labels: { style: { colors: state.settings.darkMode ? '#fff' : '#000' } }
        },
        yaxis: {
          labels: { style: { colors: state.settings.darkMode ? '#fff' : '#000' } }
        },
        dataLabels: { 
          enabled: true,
          style: { colors: [state.settings.darkMode ? '#fff' : '#000'] }
        }
      };
    } else if (chartType === 'radialBar') {
      chartOptions = {
        ...baseOptions,
        series: pieData,
        chart: { ...baseOptions.chart, type: 'radialBar' },
        plotOptions: {
          radialBar: {
            dataLabels: {
              name: { show: true, color: state.settings.darkMode ? '#fff' : '#000' },
              value: { 
                color: state.settings.darkMode ? '#fff' : '#000',
                formatter: val => formatAmount(val) 
              }
            }
          }
        },
        labels: pieLabels
      };
    } else if (chartType === 'heatmap') {
      chartOptions = {
        ...baseOptions,
        series: [{ name: 'Netto', data: dataPoints }],
        chart: { ...baseOptions.chart, type: 'heatmap' },
        dataLabels: { 
          enabled: true,
          style: { colors: [state.settings.darkMode ? '#fff' : '#000'] }
        }
      };
    } else if (chartType === 'treemap') {
      chartOptions = {
        ...baseOptions,
        series: [{ data: dataPoints }],
        chart: { ...baseOptions.chart, type: 'treemap' },
        dataLabels: { 
          enabled: true,
          style: { colors: [state.settings.darkMode ? '#fff' : '#000'] }
        }
      };
    }
    
    // Destroy previous chart and create new one
    if (state.charts.pie !== null) {
      state.charts.pie.destroy();
    }
    
    state.charts.pie = new ApexCharts(document.querySelector("#pieChart"), chartOptions);
    state.charts.pie.render();
  };
  
  const displayDataTable = data => {
    // Zachowujemy oryginalną strukturę kolumn
    const columns = CONFIG.requiredColumns.map(col => {
      if (col === '') return { title: "", data: null, defaultContent: "", orderable: false, width: "5%" };
      if (col === 'IMPORTKODPRODUKTU') return { 
        title: "Produkt", 
        data: row => row.PRODUKTKOD || '', 
        render: data => `<span class="product-code">${data}</span>` 
      };
      if (col === 'TRESC') return { 
        title: col, 
        data: row => row[col], 
        render: data => (data || '').replace(/[^a-zA-Z0-9\sąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, '') 
      };
      
      return {
        title: col,
        data: row => row[col],
        render: data => {
          if (col === 'NETTO' || col === 'VAT') return formatNumber(data);
          if (col === 'STAWKAVAT' && data) return data + '%';
          return data || '';
        }
      };
    });
    
    if (state.dataTable !== null) {
      state.dataTable.destroy();
    }
    
    state.dataTable = $('#dataTable').DataTable({
      data: data,
      columns: columns,
      dom: 'Blfrtip',
      paging: true,
      pagingType: 'full_numbers',
      lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
      pageLength: state.settings.rowsPerPage,
      deferRender: true,
      scrollY: '450px',
      scrollCollapse: false,
      buttons: [
        {
          extend: 'excel',
          text: '<i class="fas fa-file-excel"></i> Excel',
          className: 'px-2 py-1 sm:px-3 sm:py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-xs sm:text-sm text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200',
          exportOptions: { columns: ':visible' }
        },
        {
          extend: 'pdf',
          text: '<i class="fas fa-file-pdf"></i> PDF',
          className: 'px-2 py-1 sm:px-3 sm:py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-xs sm:text-sm text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200',
          exportOptions: { columns: ':visible' }
        },
        {
          extend: 'csvHtml5',
          text: '<i class="fas fa-file-csv"></i> CSV',
          className: 'px-2 py-1 sm:px-3 sm:py-2 bg-green-500 hover:bg-green-600 rounded-lg text-xs sm:text-sm text-white dark:bg-green-700 dark:hover:bg-green-800',
          title: '',
          bom: false,
          fieldSeparator: ';',
          quoteChar: '',
          escapeChar: '',
          quoteStrings: '',
          exportOptions: { columns: ':visible' },
          customize: csv => { 
            csv = csv.replace(/"/g, ''); 
            return csv.split('\n').slice(1).join('\n'); 
          }
        },
        {
          extend: 'print',
          text: '<i class="fas fa-print"></i> Drukuj',
          className: 'px-2 py-1 sm:px-3 sm:py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-xs sm:text-sm text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200',
          exportOptions: { columns: ':visible' }
        }
      ],
      language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pl.json' },
      createdRow: (row, data) => {
        const pc = data.PRODUKTKOD || '';
        if (pc) $(row).addClass('group-' + pc);
      }
    });
    
    $('#tableSearch').off('keyup').on('keyup', debounce(function() { 
      state.dataTable.search(this.value).draw(); 
    }, 300));
  };
  
  // File processing
  const processFile = file => {
    return new Promise((resolve, reject) => {
      const fileType = file.name.split('.').pop().toLowerCase();
      const reader = new FileReader();
      
      reader.onload = e => {
        try {
          let jsonData = [];
          
          if (fileType === 'csv') {
            jsonData = Papa.parse(e.target.result, { 
              header: true, 
              skipEmptyLines: true 
            }).data;
          } else if (fileType === 'xlsx' || fileType === 'xls') {
            const workbook = XLSX.read(e.target.result, { 
              type: 'binary', 
              cellDates: true 
            });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            jsonData = XLSX.utils.sheet_to_json(sheet, { raw: false });
          }
          
          const processed = processData(jsonData);
          resolve({ 
            fileName: file.name, 
            data: processed, 
            recordCount: processed.length 
          });
        } catch (err) { 
          reject(err); 
        }
      };
      
      reader.onerror = () => reject(new Error(`Błąd odczytu pliku ${file.name}`));
      
      if (fileType === 'csv') {
        reader.readAsText(file);
      } else {
        reader.readAsBinaryString(file);
      }
    });
  };
  
  const handleFiles = async files => {
    if (!files.length) return;
    
    $('#loadingSpinner').removeClass('hidden');
    
    const newFiles = Array.from(files).filter(file => 
      !state.importedFiles.some(f => f.name === file.name)
    );
    
    if(newFiles.length < files.length) {
      Array.from(files).forEach(file => {
        if(state.importedFiles.some(f => f.name === file.name)) {
          showAlert('info', `Plik ${file.name} został już zaimportowany.`);
        }
      });
    }
    
    const results = await Promise.allSettled(newFiles.map(file => processFile(file)));
    const success = [], failed = [];
    
    results.forEach((result, i) => {
      const file = newFiles[i];
      if(result.status === 'fulfilled'){
        state.importedFiles.push({ 
          name: result.value.fileName, 
          recordCount: result.value.recordCount 
        });
        state.data = [...state.data, ...result.value.data];
        success.push({ 
          name: result.value.fileName, 
          count: result.value.recordCount 
        });
      } else {
        console.error(`Error processing ${file.name}:`, result.reason);
        failed.push({ 
          name: file.name, 
          error: result.reason.message 
        });
      }
    });
    
    if (state.data.length) {
      state.summary = calculateSummaries(state.data, state.settings.groupBy);
      updateSummaryUI(state.summary);
      displayDataTable(state.data);
    }
    
    if (success.length) {
      const total = success.reduce((t, f) => t + f.count, 0),
            names = success.map(f => f.name).join(', ');
      showAlert('success', `Pomyślnie zaimportowano ${success.length} ${success.length === 1 ? 'plik' : 'pliki'} (${names}). Razem rekordów: ${total}.`);
    }
    
    if (failed.length) {
      const names = failed.map(f => f.name).join(', ');
      showAlert('error', `Nie udało się zaimportować ${failed.length} ${failed.length === 1 ? 'pliku' : 'plików'} (${names}).`);
    }
    
    $('#loadingSpinner').addClass('hidden');
  };
  
  // Event handlers
  $('#fileInput').on('change', e => { 
    handleFiles(e.target.files); 
  });
  
  $('#clearDataButton').on('click', () => {
    if (!state.data.length) { 
      showAlert('info', 'Brak danych do wyczyszczenia.'); 
      return; 
    }
    
    if (confirm('Czy na pewno chcesz wyczyścić wszystkie zaimportowane dane?')) {
      state.data = [];
      state.importedFiles = [];
      state.summary = { totalNetto: 0, totalVAT: 0, totalBrutto: 0, productGroups: {} };
      updateSummaryUI(state.summary);
      
      if (state.dataTable !== null) {
        state.dataTable.clear().draw();
      }
      
      showAlert('success', 'Wszystkie dane zostały wyczyszczone.');
    }
  });
  
  const updateFileCountBadge = () => {
    const count = state.importedFiles.length,
          badge = $('#fileCountBadge');
    
    count ? badge.text(count).removeClass('hidden') : badge.addClass('hidden');
  };
  
  // Obsługa przycisków grupowania
  $('#groupByProduct').on('click', function() {
    state.settings.groupBy = 'IMPORTKODPRODUKTU';
    updateGroupingButtons();
    saveSettings();
    
    if (state.data.length) {
      state.summary = calculateSummaries(state.data, state.settings.groupBy);
      updateSummaryUI(state.summary);
    }
  });

  $('#groupByRegistration').on('click', function() {
    state.settings.groupBy = 'NR. REJ.';
    updateGroupingButtons();
    saveSettings();
    
    if (state.data.length) {
      state.summary = calculateSummaries(state.data, state.settings.groupBy);
      updateSummaryUI(state.summary);
    }
  });

  // Funkcja do aktualizacji wyglądu przycisków grupowania
  function updateGroupingButtons() {
    $('.grouping-button').removeClass('active');
    
    if (state.settings.groupBy === 'IMPORTKODPRODUKTU') {
      $('#groupByProduct').addClass('active');
    } else if (state.settings.groupBy === 'NR. REJ.') {
      $('#groupByRegistration').addClass('active');
    }
  }
  
  $('#groupSearch').on('input', debounce(function() { 
    updateProductGroupsUI(state.summary); 
  }, 300));
  
  const dropzone = document.getElementById('dropzone');
  
  ['dragenter','dragover','dragleave','drop'].forEach(evt => {
    dropzone.addEventListener(evt, preventDefaults, false);
    document.body.addEventListener(evt, preventDefaults, false);
  });
  
  ['dragenter','dragover'].forEach(evt => {
    dropzone.addEventListener(evt, () => { 
      dropzone.classList.add('dragover'); 
    }, false);
  });
  
  ['dragleave','drop'].forEach(evt => {
    dropzone.addEventListener(evt, () => { 
      dropzone.classList.remove('dragover'); 
    }, false);
  });
  
  dropzone.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files && files.length) { 
      handleFiles(files); 
    }
  });
  
  dropzone.addEventListener('click', () => { 
    document.getElementById('fileInput').click(); 
  });
  
  document.addEventListener("DOMContentLoaded", function() {
  // Ustaw domyślne grupowanie według produktu
  const productGroupButton = document.querySelector('[data-group="product"]');
  if (productGroupButton) {
    productGroupButton.classList.add('active');
    applyGrouping('product');
  }
});

  // Poprawiona obsługa kliknięcia nagłówka grupy
  $(document).on('click', '.group-header', function() {
    const details = $(this).siblings('.group-details'),
          icon = $(this).find('i.fa-chevron-down');
    
    if(details.is(':visible')) {
      details.slideUp(300);
      icon.css('transform', 'rotate(0)');
    } else {
      details.slideDown(300);
      icon.css('transform', 'rotate(180deg)');
    }
  });
  
  // Obsługa ładowania dodatkowych wierszy w grupach
  $(document).on('click', '.load-more-row', function() {
    const row = $(this);
    const groupIndex = row.data('group-index');
    const groupName = row.data('group-name');
    const loaded = parseInt(row.data('loaded'));
    const group = state.summary.productGroups[groupName];
    
    if (!group) return;
    
    const details = group.details;
    const remaining = details.length - loaded;
    const toLoad = Math.min(remaining, GROUP_ROW_CHUNK);
    
    if (toLoad <= 0) return;
    
    const newRows = renderGroupRows(details, loaded, toLoad);
    row.before(newRows);
    
    const newLoaded = loaded + toLoad;
    row.data('loaded', newLoaded);
    
    // Jeśli załadowano wszystkie wiersze, ukryj przycisk
    if (newLoaded >= details.length) {
      row.remove();
    } else {
      // Aktualizuj tekst przycisku
      const stillToLoad = details.length - newLoaded;
      row.find('td').text(`Pokaż więcej (pozostało ${stillToLoad})`);
    }
  });
  
  $('#chartTypeSelect').on('change', function() {
    state.settings.chartType = $(this).val();
    saveSettings();
    
    if (state.data.length) {
      const chartSummary = calculateSummaries(state.data, 'IMPORTKODPRODUKTU');
      updateCharts(chartSummary);
    }
  });
  
  $('#exportExcel').on('click', e => { 
    e.preventDefault(); 
    $('.buttons-excel').click(); 
  });
  
  $('#exportPDF').on('click', e => { 
    e.preventDefault(); 
    $('.buttons-pdf').click(); 
  });
  
  $('#exportCSV').on('click', e => { 
    e.preventDefault(); 
    $('.buttons-csv').click(); 
  });
  
  $('#exportButton').on('click', () => { 
    $('#exportDropdown').toggleClass('hidden'); 
  });
  
  $(document).on('click', e => {
    if (!$(e.target).closest('#exportButton').length && 
        !$(e.target).closest('#exportDropdown').length) {
      $('#exportDropdown').addClass('hidden');
    }
  });
  
  // Tryb ciemny
  $('#darkModeToggle').on('change', function() {
    state.settings.darkMode = this.checked;
    saveSettings();
    applyTheme();
    
    // Po zmianie motywu, aktualizujemy wykresy
    if (state.charts.pie !== null) {
      const chartSummary = calculateSummaries(state.data, 'IMPORTKODPRODUKTU');
      updateCharts(chartSummary);
    }
  });
  
  $('#printButton').on('click', () => { 
    $('.buttons-print').click(); 
  });
  
  // Obsługa zbiorczego rozwijania/zwijania grup
  $('#expandAllGroups').on('click', () => {
    $('.group-details').slideDown(300);
    $('.group-header i.fa-chevron-down').css('transform', 'rotate(180deg)');
  });
  
  $('#collapseAllGroups').on('click', () => {
    $('.group-details').slideUp(300);
    $('.group-header i.fa-chevron-down').css('transform', 'rotate(0)');
  });
  
  // Notifications
  function showAlert(type, message) {
    const cls = type === 'success'
      ? 'bg-green-100 border-green-500 text-green-800 dark:bg-green-900/30 dark:border-green-600 dark:text-green-400'
      : type === 'info'
        ? 'bg-blue-100 border-blue-500 text-blue-800 dark:bg-blue-900/30 dark:border-blue-600 dark:text-blue-400'
        : 'bg-red-100 border-red-500 text-red-800 dark:bg-red-900/30 dark:border-red-600 dark:text-red-400';
    
    const icon = type === 'success'
      ? '<i class="fas fa-check-circle"></i>'
      : type === 'info'
        ? '<i class="fas fa-info-circle"></i>'
        : '<i class="fas fa-exclamation-circle"></i>';
    
    const alert = $(`
      <div class="p-3 mb-4 rounded-lg border-l-4 ${cls} animate-fade-in">
        <div class="flex items-center">
          <div class="flex-shrink-0 mr-2">${icon}</div>
          <div>${message}</div>
          <button type="button" class="ml-auto -mx-1.5 -my-1.5 rounded-lg p-1.5 inline-flex h-8 w-8 focus:outline-none">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>`);
    
    $('#alertContainer').removeClass('hidden').prepend(alert);
    
    setTimeout(() => {
      alert.fadeOut(300, function() {
        $(this).remove();
        if (!$('#alertContainer').children().length) { 
          $('#alertContainer').addClass('hidden'); 
        }
      });
    }, 5000);
    
    alert.find('button').on('click', function() {
      alert.fadeOut(300, function() {
        $(this).remove();
        if (!$('#alertContainer').children().length) { 
          $('#alertContainer').addClass('hidden'); 
        }
      });
    });
  }
  
  // Settings management
  function saveSettings() { 
    localStorage.setItem('importPSFSettings', JSON.stringify(state.settings)); 
  }
  
  function loadSettings() {
    const saved = localStorage.getItem('importPSFSettings');
    if (saved) {
      try {
        const savedSettings = JSON.parse(saved);
        state.settings = { ...state.settings, ...savedSettings };
        $('#darkModeToggle').prop('checked', state.settings.darkMode);
        $('#chartTypeSelect').val(state.settings.chartType);
        updateGroupingButtons();
      } catch (e) {
        console.error("Błąd podczas ładowania ustawień:", e);
        localStorage.removeItem('importPSFSettings');
      }
    }
  }
  
  // Theme application
  function applyTheme() {
    if (state.settings.darkMode) { 
      document.documentElement.classList.add('dark'); 
    } else { 
      document.documentElement.classList.remove('dark'); 
    }
  }
  
  // Utilities
  function preventDefaults(e) { 
    e.preventDefault(); 
    e.stopPropagation(); 
  }
  
  // Initialization
  loadSettings();
  applyTheme();
});
</script>
</body>
</html>
